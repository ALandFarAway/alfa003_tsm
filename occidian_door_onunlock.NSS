////////////////////////////////////////////////////////////////////////////////
//
//  System Name : ACR Configuration File
//     Filename : acf_door_onunlock 
//    $Revision:: 233        $ current version of the file
//        $Date:: 2007-01-20#$ date the file was created or modified
//       Author : Ronan
//
//  Local Variable Prefix =
//
//
//  Dependencies external of nwscript:
//
//  Description
//  This script calls the ACR's OnUnlock code for doors, and any custom code
//  a server may need. It is not updated in ACR updates.
//
//  Revision History
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Includes ////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

#include "acr_door_i"

////////////////////////////////////////////////////////////////////////////////
// Constants ///////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Structures //////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Global Variables ////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Function Prototypes /////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Function Definitions ////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

void main() {
    ACR_DoorOnUnlock();
	
	object oGeasWP = GetObjectByTag("Occ_Geas_WP", 0);
	object oGlyphWP = GetObjectByTag("occ_plc_glyph_warding_wp", 0);
	object oPC = GetLastUnlocked();
	int eLevel = GetTotalLevels(oPC, FALSE);
	
	 if((GetLocalInt(OBJECT_SELF, "Fired") == 0) && (eLevel < 8) && (GetTag(OBJECT_SELF) == "plc_dc_gtdra03"))
        {if(WillSave(oPC,17, SAVING_THROW_TYPE_MIND_SPELLS, OBJECT_SELF))
			{SendMessageToPC(oPC, "A strange sensation passes through you, as if you feel a momentary impulse to relock the door and leave the vicinity...but it passes." );
			}
			
		else if (GetTag(OBJECT_SELF) == "plc_dc_gtdra03")
			 {AssignCommand(oPC, ActionLockObject(OBJECT_SELF));
			  DelayCommand(3.0, AssignCommand(oPC, ActionMoveToObject(oGeasWP, TRUE, 1.0)));
	          SendMessageToPC(oPC, "You find yourself suddenly convinced that it is imperative that you relock the door and leave the vicinity. The compulsion is irresistable." );
			  }
		SetLocalInt(OBJECT_SELF, "Fired", 1);	  
		object oGlyph = CreateObject(OBJECT_TYPE_PLACEABLE, "occ_plc_glyph_warding", GetLocation(oGlyphWP));
		DestroyObject(oGlyph, 6.0);
			  
		 	}

}