////////////////////////////////////////////////////////////////////////////////
//
//  System Name : ACR Configuration File
//     Filename : acf_door_onfailtoopen 
//    $Revision:: 233        $ current version of the file
//        $Date:: 2007-01-20#$ date the file was created or modified
//       Author : Ronan
//
//  Local Variable Prefix =
//
//
//  Dependencies external of nwscript:
//
//  Description
//  This script calls the ACR's OnFailToOpen code for doors, and any custom code
//  a server may need. It is not updated in ACR updates.
//
//  Revision History
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Includes ////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

#include "acr_door_i"

////////////////////////////////////////////////////////////////////////////////
// Constants ///////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Structures //////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Global Variables ////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Function Prototypes /////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Function Definitions ////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void ActionCreateItemOnObject(string sItem, object oObject)
{
    CreateItemOnObject(sItem, oObject, 1);
}

void main() {
    ACR_DoorOnFailToOpen();
	
	object oNio = GetLastUsedBy();
	
	
	if(GetTag(OBJECT_SELF) == "5f_ext_dt_tombs_nobles") {
			SendMessageToAllDMs(GetName(oNio) + " is unlocking " + GetName(OBJECT_SELF));
			object oScarab = GetItemInSlot(INVENTORY_SLOT_NECK, oNio);
			object oScarabB = GetItemPossessedBy(oNio, "03_it_amul_scarab_prot");
			DestroyObject(oScarab);
			DestroyObject(oScarabB);
			effect eLowerWill = EffectSavingThrowDecrease( SAVING_THROW_WILL, 1, SAVING_THROW_TYPE_ALL);
			ActionSpeakString("The scarab at your neck sinks its mandibles into your carotid!", TALKVOLUME_TALK);
			if(WillSave(oNio, 20, SAVING_THROW_TYPE_NEGATIVE, oScarab)) {SendMessageToPC(oNio, "You feel woozy.");}
			else {ApplyEffectToObject(DURATION_TYPE_PERMANENT, eLowerWill, oNio);
				SendMessageToPC(oNio, "You feel a rush of assurance. This door *will* open to you.");
				}
			DelayCommand(15.0, ActionSpeakString("The scarab pulls its mandibles free, and spreads irridescent wings. It jumps to the doorframe and inserts its six legs and bloody mandibles into the eight holes on the door. Antennae unfurl, with small fans at their tips that settle gently into the upper indentations on the door.", TALKVOLUME_TALK));
			DelayCommand(29.0, ActionCreateItemOnObject("003_it_amul_scarab_prot", oNio));
			DelayCommand(30.0, ActionSpeakString("The door unlocks. The scarab spreads wings and whirs back to your collar.", TALKVOLUME_TALK));
			DelayCommand(30.0, ActionUnlockObject(OBJECT_SELF));
			}
	
}